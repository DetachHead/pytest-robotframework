name: check and publish

on: push

permissions:
  contents: "write"
  packages: "write"
  pull-requests: "read"

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        python_version: ["3.8", "3.12"]
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        robot_version: ["6.1.1", "from lockfile"]
        pytest_version: ["8.0", "from lockfile"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: eifinger/setup-rye@v2
      - run: rye pin ${{ matrix.python_version }}
      - run: rye sync --no-lock
      - run: rye add robotframework==${{ matrix.robot_version }}
        if: ${{ matrix.robot_version != 'from lockfile' }}
      - run: rye add pytest==${{ matrix.pytest_version }}
        if: ${{ matrix.pytest_version != 'from lockfile' }}
      - run: rye test
  static_checks:
    strategy:
      fail-fast: false
      matrix:
        python_version: ["3.8", "3.12"]
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: eifinger/setup-rye@v2
      - run: rye pin ${{ matrix.python_version }}
      # https://github.com/astral-sh/rye/issues/945
      # - run: rye lock --check
      - run: rye sync
      - run: rye run typecheck
      - run: rye lint
      - run: rye fmt --check -- --diff
      - run: rye run pylint_check
      - run: rye run robocop
      - run: rye run robotidy_check
  publish:
    runs-on: "ubuntu-latest"
    if: github.ref == 'refs/heads/master'
    needs:
      - static_checks
      - test
    permissions:
      id-token: write
      contents: write
      packages: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v2
      - uses: eifinger/setup-rye@v2
      - run: rye pin 3.12
      - run: rye publish
      - name: get version number
        id: current-version
        run: echo ::set-output name=CURRENT_VERSION::$(rye version)
      - uses: marvinpinto/action-automatic-releases@v1.2.1
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          files: dist/*
          automatic_release_tag: ${{ steps.current-version.outputs.CURRENT_VERSION }}
